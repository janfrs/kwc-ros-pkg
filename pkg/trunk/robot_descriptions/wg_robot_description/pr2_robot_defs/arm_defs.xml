<?xml version="1.0"?>
<robot>

  <property name="M_PI" value="3.1415926535897931" />

  <property name="shoulder_pitch_length" value="0.10" />
  <property name="shoulder_pitch_radius" value="0.12" />


  <macro name="finger" params="prefix side parent reflect">

    <!-- Finger proximal digit -->

    <joint name="finger_${prefix}_${side}_joint" type="revolute">
      <axis xyz="0 0 1" />
      <anchor xyz="0 0 0" />
      <calibration values="1.5 -1 " />
      <limit effort="100" velocity="10" min="-100" max="100" />
      <joint_properties damping="0.05" />
    </joint>

    <link name="finger_${prefix}_${side}">
      <parent name="${parent}" />
      <origin xyz="0.07751 ${reflect*0.01} 0" rpy="0 0 0" />

      <joint name="finger_${prefix}_${side}_joint" />
      <inertial>
        <mass value="0.1" />
        <com xyz="0 0 0" />
        <inertia  ixx="0.012430552544" ixy="-0.000003671102" ixz="0.000029379389"
                  iyy="0.013567548848" iyz="-0.000427679042" izz="0.001755089866" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Shell</elem>
        </map>
        <geometry name="finger_${prefix}_mesh_file">
          <mesh filename="finger-${prefix}" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry name="finger_${side}_collision_geom">
          <box size="0.131 0.056 0.049" />
        </geometry>
        <verbose value="Yes" />
      </collision>
      <map name="finger_${prefix}_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>


    <!-- Finger tip -->

    <joint name="finger_tip_${prefix}_${side}_joint" type="revolute">
      <axis xyz="0 0 1" />
      <anchor xyz="0 0 0" />
      <limit effort="100" velocity="10" min="-100" max="100" />
      <joint_properties damping="0.01" />
    </joint>

    <link name="finger_tip_${prefix}_${side}">
      <parent name="finger_${prefix}_${side}" />
      <origin xyz="0.0915 0 0" rpy=" 0 0 0 " />

      <joint name="finger_tip_${prefix}_${side}_joint" />
      <inertial>
        <mass value="0.1" />
        <com xyz=" 0 0 0 " />
        <inertia  ixx="0.012430552544" ixy="-0.000003671102" ixz="0.000029379389"
                  iyy="0.013567548848" iyz="-0.000427679042" izz="0.001755089866" />
      </inertial>
      <visual>
        <origin xyz="0 0 0 " rpy="0 0 0 " />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Green</elem>
        </map>
        <geometry name="finger_tip_${prefix}_mesh_file">
          <mesh filename="finger-tip-${prefix}" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0 " rpy="0 0 0" />
        <geometry name="finger_tip_${side}_collision_geom">
          <box size="0.053 0.04 0.023" />
        </geometry>
        <verbose value="Yes" />
      </collision>
      <map name="finger_tip_${prefix}_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>
  </macro>



  <macro name="pr2_gripper" params="side parent">
    <joint name="gripper_roll_${side}_joint" type="fixed" />
    <link name="gripper_roll_${side}">
      <parent name="${parent}" />
      <joint name="gripper_roll_${side}_joint" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <inertial>
        <mass value="1.0" />
        <com xyz="0.179474 -0.000058  0.013779" />
        <inertia  ixx="1.0" ixy="-0.000003671102" ixz="0.000029379389"
                  iyy="1.0" iyz="-0.000427679042" izz="1.0" />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Red</elem>
        </map>
        <geometry name="gripper_roll_mesh_file">
          <mesh filename="wr_roll" />
        </geometry>
      </visual>

      <collision>
        <origin xyz="0.05 0 0" rpy="0 0 0" />
        <geometry name="gripper_roll_collision_geom">
          <box size="0.11 0.10 0.05" />
        </geometry>
        <verbose value="Yes" />
      </collision>

      <map name="gripper_roll_left_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>

    <finger prefix="l" side="${side}" parent="gripper_roll_${side}" reflect="1" />
    <finger prefix="r" side="${side}" parent="gripper_roll_${side}" reflect="-1" />

    <transmission type="GripperTransmission" name="gripper_${side}_trans">
      <actuator name="gripper_${side}_motor" />
      <joint name="finger_r_${side}_joint" reduction="-1000.0" />
      <joint name="finger_tip_r_${side}_joint" reduction="1000.0" />
      <joint name="finger_l_${side}_joint" reduction="1000.0" />
      <joint name="finger_tip_l_${side}_joint" reduction="-1000.0" />
      <pid p="0.10" i="0.0" d="0.005" iClamp="0.5" />
    </transmission>
  </macro>



  <macro name="upperarm" params="side parent reflect *origin">

    <!-- Shoulder pan -->

    <joint name="shoulder_pan_${side}_joint" type="revolute">
      <axis xyz="0 0 1" />
      <!-- TODO: the arm on the test stand has the optical switch at 0.  It is actually
           at 45 degrees -->
      <limit min="-1.5" max="1.5" effort="30" velocity="5" />
      <calibration reference_position="0" values="1.5 -1" />
      <safety_limit_min safety_length="0.15" damping_constant="20" spring_constant="100" />
      <safety_limit_max safety_length="0.15" damping_constant="20" spring_constant="100" />
      <joint_properties damping="10.0" />
    </joint>

    <link name="shoulder_pan_${side}">
      <parent name="${parent}" />
      <insert_block name="origin" />
      <joint name="shoulder_pan_${side}_joint" />
      <inertial>
        <mass value="16.29553" />
        <com xyz="-0.005215 -0.030552 0.0" />
        <inertia ixx="0.793291393007"  ixy="0.003412032973"  ixz="0.0096614481"
                 iyy="0.818419457224"  iyz="-0.033999499551" izz="0.13915007406" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Blue</elem>
        </map>
        <geometry name="sholder_pan_mesh_file">
          <mesh filename="shoulder_yaw" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0.05 0 -0.2" rpy="0 0 0 " />
        <geometry name="shoulder_pan_collision_box_geom">
          <box size="0.347 0.254 0.646" />
        </geometry>
      </collision>
      <map name="shoulder_pan_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>

    <transmission type="SimpleTransmission" name="shoulder_pan_${side}_trans">
      <actuator name="shoulder_pan_${side}_motor" />
      <joint name="shoulder_pan_${side}_joint" />
      <mechanicalReduction>63.16</mechanicalReduction>
    </transmission>

    <!-- Shoulder pitch -->

    <joint name="shoulder_pitch_${side}_joint" type="revolute">
      <axis xyz="0 1 0" />
      <anchor xyz="0 0 0" />
      <limit min="-0.4" max="1.5" effort="30" velocity="5" />
      <calibration reference_position="0" values="1.5 -1 " />
      <safety_limit_min safety_length="0.1" spring_constant="50" damping_constant="12"/>
      <safety_limit_max safety_length="0.1" spring_constant="50" damping_constant="12"/>
      <joint_properties damping="100.0" />
    </joint>

    <link name="shoulder_pitch_${side}">
      <parent name="shoulder_pan_${side}" />
      <origin xyz="0.1 0 0" rpy="0 0 0" />
      <joint name="shoulder_pitch_${side}_joint" />
      <inertial>
        <mass value="2.41223" />
        <com xyz="-0.035895  0.014422 -0.0028263" />
        <inertia ixx="0.016640333585" ixy="0.002696462583"  ixz="0.001337742275"
                 iyy="0.017232603914" iyz="-0.003605106514" izz="0.018723553425" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Grey</elem>
        </map>
        <geometry name="sholder_pitch_mesh_file">
          <mesh filename="shoulder_pitch" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="${shoulder_pitch_length/2} 0 0 " rpy="${M_PI/2} 0 0" />
        <geometry name="shoulder_pitch_collision_geom">
          <cylinder radius="${shoulder_pitch_radius}" length="${shoulder_pitch_length}" />
        </geometry>
      </collision>
    </link>

    <transmission type="SimpleTransmission" name="shoulder_pitch_${side}_trans">
      <actuator name="shoulder_pitch_${side}_motor" />
      <joint name="shoulder_pitch_${side}_joint" />
      <mechanicalReduction>57.36</mechanicalReduction>
    </transmission>

    <!-- Upperarm roll -->

    <joint name="upperarm_roll_${side}_joint" type="revolute">
      <axis xyz="1 0 0" />
      <anchor xyz="0 0 0" />
      <limit min="-3.9" max="0.8" effort="30" velocity="5" />
      <calibration reference_position="${-M_PI/2}" values="1.5 -1 " />
      <safety_limit_min safety_length="0.15" spring_constant="80" damping_constant="5"/>
      <safety_limit_max safety_length="0.15" spring_constant="80" damping_constant="5"/>
      <joint_properties damping="1.0" />
    </joint>

    <link name="upperarm_roll_${side}">
      <parent name="shoulder_pitch_${side}" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <joint name="upperarm_roll_${side}_joint" />

      <inertial>
        <mass value="4.9481" />
        <com xyz=" 0.21227 0.001205 -0.016293  " />
        <inertia  ixx="10.0" ixy="0.000547745916"  ixz="0.000119476885"
                  iyy="1.0"  iyz="0.001544932307"  izz="1.0" />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Green</elem>
        </map>
        <geometry name="shoulder_roll_mesh_file">
          <mesh filename="upperarm_roll" />
        </geometry>
      </visual>

      <collision>
        <origin xyz="0.3 0 0" rpy="0 0 0" />
        <geometry name="upperarm_roll_collision_geom">
          <box size="0.362 0.144 0.157" />
        </geometry>
      </collision>

      <map name="upperarm_roll_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>

    <transmission type="SimpleTransmission" name="upperarm_roll_${side}_trans">
      <actuator name="upperarm_roll_${side}_motor" />
      <joint name="upperarm_roll_${side}_joint" />
      <mechanicalReduction>32.65</mechanicalReduction>
    </transmission>

    <!-- Elbow flex -->

    <joint name="elbow_flex_${side}_joint" type="revolute">
      <axis xyz="0 -1 0" />
      <anchor xyz="0 0 0" />
      <limit min="-0.1" max="2.3" effort="30" velocity="5" />
      <calibration reference_position="1.1" values="1.5 -1" />
      <safety_limit_min safety_length="0.1" spring_constant="60" damping_constant="6"/>
      <safety_limit_max safety_length="0.4" spring_constant="60" damping_constant="6"/>
      <joint_properties damping="10.0" />
    </joint>

    <link name="elbow_flex_${side}">
      <parent name="upperarm_roll_${side}" />
      <origin xyz="0.4 0 0" rpy="0 0 0" />
      <joint name="elbow_flex_${side}_joint" />

      <inertial>
        <mass value="1.689246" />
        <com xyz="-0.011638  0.013173 0.001228 " />
        <inertia  ixx="10.0" ixy="0.000292046674"  ixz="-0.000077359282"
                  iyy="1.0"  iyz="-0.000001162155" izz="1.0" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Grey</elem>
        </map>
        <geometry name="elbow_flex_mesh_file">
          <mesh filename="elbow_pitch" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0" />
        <geometry name="elbow_flex_collision_geom">
          <cylinder radius="0.1" length="0.08" />
        </geometry>
      </collision>
      <map name="elbow_flex_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>

    <transmission type="SimpleTransmission" name="elbow_flex_${side}_trans">
      <actuator name="elbow_flex_${side}_motor" />
      <joint name="elbow_flex_${side}_joint" />
      <mechanicalReduction>36.17</mechanicalReduction>
    </transmission>
  </macro>



  <macro name="forearm" params="side parent reflect">

    <!-- Forearm roll -->

    <joint name="forearm_roll_${side}_joint" type="revolute">
      <axis xyz="-1 0 0" />
      <anchor xyz="0 0 0" />
      <limit  effort="100" velocity="5" />
      <calibration reference_position="0" values="1.5 -1" />
      <joint_properties damping="1.0" />
    </joint>

    <link name="forearm_roll_${side}">
      <parent name="${parent}" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <joint name="forearm_roll_${side}_joint" />
      <inertial>
        <mass value="1.804155" />
        <com xyz="0.179474 -0.000058 0.013779" />
        <inertia ixx="10.0" ixy="-0.000003671102" ixz="0.000029379389"
                 iyy="1.0" iyz="-0.000427679042" izz="1.0" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Blue</elem>
        </map>
        <geometry name="forearm_roll_mesh_file">
          <mesh filename="forearm_roll" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0.22 0 0" rpy="0 0 0" />
        <geometry name="forearm_roll_collision_geom">
          <box size="0.27 0.12 0.08" />
        </geometry>
      </collision>
      <map name="forearm_roll_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>

    <transmission type="SimpleTransmission" name="forearm_roll_${side}_trans">
      <actuator name="forearm_roll_${side}_motor" />
      <joint name="forearm_roll_${side}_joint" />
      <mechanicalReduction>${576/25*55/14}</mechanicalReduction>
    </transmission>

    <!-- Wrist flex -->

    <joint name="wrist_flex_${side}_joint" type="revolute">
      <axis xyz="0 -1 0" />
      <anchor xyz="0 0 0" />
      <limit min="-0.1" max="2.2" effort="200" velocity="5" />
      <calibration reference_position="0.4" values="1.5 -1" />
      <safety_limit_min safety_length="0.2" spring_constant="15" damping_constant="4"/>
      <safety_limit_max safety_length="0.2" spring_constant="15" damping_constant="4"/>
      <joint_properties damping="1.0" />
    </joint>

    <link name="wrist_flex_${side}">
      <parent name="forearm_roll_${side}" />
      <origin xyz="0.32025 0 0" rpy="0 0 0" />
      <joint name="wrist_flex_${side}_joint" />
      <inertial>
        <mass value="0.1" />
        <com xyz="0 0 0" />
        <inertia ixx="1.0" ixy="-0.000003671102" ixz="0.000029379389"
                 iyy="1.0" iyz="-0.000427679042" izz="1.0" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Grey</elem>
        </map>
        <geometry name="wrist_flex_mesh_file">
          <mesh filename="wrist_pitch" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="${M_PI/2} 0 0" />
        <geometry name="wrist_flex_collision_geom">
          <cylinder radius="0.033" length="0.103" />
        </geometry>
      </collision>
      <map name="wrist_flex_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>

    <!-- Wrist roll -->

    <joint name="wrist_roll_${side}_joint" type="revolute">
      <axis xyz="1 0 0" />
      <anchor xyz="0 0 0" />
      <limit effort="10" velocity="5" />
      <!--<calibration reference_position="${-0.3+M_PI/2}" values="1.5 -1" />-->
      <calibration reference_position="1.27" values="1.5 -1" />
      <joint_properties damping="1.0" />
    </joint>


    <link name="wrist_roll_${side}">
      <parent name="wrist_flex_${side}" />
      <origin xyz="0 0 0" rpy="0 0 0" />
      <joint name="wrist_roll_${side}_joint" />
      <inertial>
        <mass value="1.0" />
        <com xyz="0.179474 -0.000058  0.013779" />
        <inertia ixx="1.0" ixy="-0.000003671102" ixz="0.000029379389"
                 iyy="1.0" iyz="-0.000427679042" izz="1.0" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <map name="gazebo_material" flag="gazebo">
          <elem key="material">Gazebo/Red</elem>
        </map>
        <geometry name="wrist_roll_mesh_file">
          <mesh filename="wr_roll" />
        </geometry>
      </visual>
      <collision>
        <origin xyz="0.05 0 0" rpy="0 0 0" />
        <geometry name="wrist_roll_collision_geom">
          <box size="0.11 0.10 0.05" />
        </geometry>
        <verbose value="Yes" />
      </collision>
      <map name="wrist_roll_${side}_gravity" flag="gazebo">
        <elem key="turnGravityOff">true</elem>
      </map>
    </link>

    <transmission type="WristTransmission" name="wrist_${side}_trans">
      <rightActuator name="wrist_r_${side}_motor" />
      <leftActuator name="wrist_l_${side}_motor" />
      <flexJoint name="wrist_flex_${side}_joint" mechanicalReduction="${624/35*54/16}" />
      <rollJoint name="wrist_roll_${side}_joint" mechanicalReduction="${624/35*54/16}" />
    </transmission>

  </macro>



  <macro name="pr2_arm" params="side parent reflect *origin">
    <upperarm side="${side}" reflect="${reflect}" parent="${parent}">
      <insert_block name="origin" />
    </upperarm>
    <forearm side="${side}" reflect="${reflect}" parent="elbow_flex_${side}" />
  </macro>



  <!--                    Calibration                            -->


  <macro name="upperarm_calibrator" params="side">
    <controller name="cal_shoulder_pan_${side}" topic="cal_shoulder_pan_${side}"
                type="JointCalibrationControllerNode">
      <calibrate joint="shoulder_pan_${side}_joint"
                 actuator="shoulder_pan_${side}_motor"
                 transmission="shoulder_pan_${side}_trans"
                 velocity="1.0" />
      <pid p="7" i="0.5" d="0" iClamp="1.0" />
    </controller>

    <controller name="cal_shoulder_pitch_${side}" topic="cal_shoulder_pitch_${side}"
                type="JointCalibrationControllerNode">
      <calibrate joint="shoulder_pitch_${side}_joint"
                 actuator="shoulder_pitch_${side}_motor"
                 transmission="shoulder_pitch_${side}_trans"
                 velocity="-1.0" />
      <pid p="7" i="0.5" d="0" iClamp="1.0" />
    </controller>

    <controller name="cal_upperarm_roll_${side}" topic="cal_upperarm_roll_${side}"
                type="JointCalibrationControllerNode">
      <calibrate joint="upperarm_roll_${side}_joint"
                 actuator="upperarm_roll_${side}_motor"
                 transmission="upperarm_roll_${side}_trans"
                 velocity="1.0" />
      <pid p="6" i="0.2" d="0" iClamp="2.0" />
    </controller>

    <controller name="cal_elbow_flex_${side}" topic="cal_elbow_flex_${side}"
                type="JointCalibrationControllerNode">
      <calibrate joint="elbow_flex_${side}_joint"
                 actuator="elbow_flex_${side}_motor"
                 transmission="elbow_flex_${side}_trans"
                 velocity="1.0" />
      <pid p="6" i="0.2" d="0" iClamp="1.0" />
    </controller>
  </macro>


  <macro name="forearm_calibrator" params="side">
    <controller name="cal_forearm_roll_${side}" type="JointCalibrationControllerNode">
      <calibrate joint="forearm_roll_${side}_joint"
                 actuator="forearm_roll_${side}_motor"
                 transmission="forearm_roll_${side}_trans"
                 velocity="-1.2" />
      <pid p="5.0" i="0" d="0" iClamp="0" />
    </controller>

    <controller type="WristCalibrationControllerNode" name="cal_wrist">
      <calibrate transmission="wrist_trans_${side}"
                 actuator_l="wrist_l_${side}_motor" actuator_r="wrist_r_${side}_motor"
                 flex_joint="wrist_flex_${side}_joint" roll_joint="wrist_roll_${side}_joint"
                 velocity="1.2" />
      <pid p="3.0" i="0.2" d="0" iClamp="2.0" />
    </controller>
  </macro>


  <macro name="gripper_calibrator" params="side">
    <controller name="cal_gripper_${side}" type="GripperCalibrationControllerNode">
      <calibrate joint="finger_r_${side}_joint"
                 actuator="gripper_${side}_motor"
                 velocity="10" />
      <pid p="15" i="0" d="0" iClamp="0" />
    </controller>
  </macro>

</robot>
